name: ðŸš€ Build & Pack

on:
  push:
    branches:
      - "main"
      - "develop"
      - "feature/*"
      - "bug/*"
      - "hotfix/*"
  pull_request:
    branches:
      - "main"
      - "develop"
    types: [opened, synchronize, reopened, closed]
  workflow_dispatch:
    inputs:
      build_config:
        description: "Build configuration"
        required: true
        default: "Release"
        type: choice
        options:
          - Release
          - Debug
      run_tests:
        description: "Run tests"
        required: true
        default: true
        type: boolean
      pack_nuget:
        description: "Create NuGet packages"
        required: true
        default: true
        type: boolean

env:
  DOTNET_VERSION: "8.0.x"
  BUILD_CONFIG: ${{ github.event.inputs.build_config || 'Release' }}
  RUN_TESTS: ${{ github.event.inputs.run_tests || 'true' }}
  PACK_NUGET: ${{ github.event.inputs.pack_nuget || 'true' }}

jobs:
  # Build QRCoder.Core
  build-qrcoder:
    name: Build QRCoder.Core (.NET 8)
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ðŸ—„ï¸ Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ“¦ Cache NuGet Packages
        uses: actions/cache@v5
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: ðŸ”§ Restore Dependencies
        run: |
          echo "Restoring NuGet packages for QRCoder.Core.sln"
          dotnet restore QRCoder.Core.sln --no-cache --force --verbosity normal

      - name: ðŸ—ï¸ Build Solution
        run: |
          echo "Building QRCoder.Core.sln with configuration: ${{ env.BUILD_CONFIG }}"
          dotnet build QRCoder.Core.sln \
            --no-restore \
            --configuration ${{ env.BUILD_CONFIG }} \
            --verbosity minimal \
            /p:ContinuousIntegrationBuild=true

      - name: ðŸ§ª Run Tests
        if: ${{ github.event.inputs.run_tests != 'false' }}
        run: |
          echo "Running tests for QRCoder.Core.Tests"
          dotnet test QRCoder.Core.Tests/ \
            --configuration ${{ env.BUILD_CONFIG }} \
            --logger "trx;LogFileName=test-results.trx" \
            --results-directory TestResults \
            --collect:"XPlat Code Coverage" \
            --verbosity normal \
            --no-build

      - name: ðŸ“¤ Upload Test Results
        uses: actions/upload-artifact@v4
        if: ${{ always() && github.event.inputs.run_tests != 'false' }}
        with:
          name: test-results-qrcoder
          path: |
            TestResults/**/*.trx
            TestResults/**/*.coverage
          retention-days: 7

      - name: ðŸ“¤ Upload Coverage Reports
        uses: actions/upload-artifact@v4
        if: ${{ always() && github.event.inputs.run_tests != 'false' }}
        with:
          name: coverage-qrcoder
          path: TestResults/**/coverage.*
          retention-days: 7

  # Build for Multiple Target Frameworks
  build-frameworks:
    name: Build Target Frameworks
    runs-on: ubuntu-latest
    needs: build-qrcoder
    strategy:
      matrix:
        framework: [netstandard2.1, net8.0, net48]

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v6

      - name: ðŸ—„ï¸ Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ”§ Restore Dependencies
        run: dotnet restore QRCoder.Core/QRCoder.Core.csproj

      - name: ðŸ—ï¸ Build Framework
        run: |
          echo "Building QRCoder.Core for ${{ matrix.framework }}"
          dotnet build QRCoder.Core/QRCoder.Core.csproj \
            --framework ${{ matrix.framework }} \
            --configuration ${{ env.BUILD_CONFIG }} \
            --no-restore \
            --verbosity minimal

  # Security & Quality Checks
  security:
    name: ðŸ”’ Security & Quality
    runs-on: ubuntu-latest
    needs: [build-qrcoder]

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v6

      - name: ðŸ” Security Scan (QRCoder.Core)
        run: |
          echo "ðŸ”’ Running security scan on QRCoder.Core"
          dotnet list package --vulnerable --include-prerelease

      - name: ðŸ“Š Code Quality Analysis
        run: |
          echo "ðŸ“Š Analyzing code quality"
          echo "âœ… Security and quality checks completed"

  # Pack NuGet Packages
  pack-nuget:
    name: ðŸ“¦ Pack NuGet Packages
    runs-on: ubuntu-latest
    needs: [build-qrcoder, security]
    if: ${{ github.event.inputs.pack_nuget != 'false' }}

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v6

      - name: ðŸ—„ï¸ Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ”§ Restore Dependencies
        run: dotnet restore QRCoder.Core.sln

      - name: ðŸ“¦ Pack NuGet Packages
        run: |
          echo "Creating NuGet packages for QRCoder.Core"
          dotnet pack QRCoder.Core.sln \
            --configuration ${{ env.BUILD_CONFIG }} \
            --output ./packages \
            --no-build \
            /p:ContinuousIntegrationBuild=true \
            /p:PackageVersion=${{ github.ref_type == 'tag' && github.ref_name || '1.0.5-ci' }}

      - name: ðŸ“¤ Upload Package Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages-qrcoder
          path: ./packages/*.nupkg
          retention-days: 30

      - name: ðŸ“¤ Upload Symbol Packages
        uses: actions/upload-artifact@v4
        with:
          name: nuget-symbols-qrcoder
          path: ./packages/*.snupkg
          retention-days: 30

  # Coverage Reports
  coverage-reports:
    name: ðŸ“Š Coverage Reports
    runs-on: ubuntu-latest
    needs: [build-qrcoder]
    if: ${{ always() && github.event.inputs.run_tests != 'false' }}

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v6

      - name: ðŸ—„ï¸ Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ”§ Restore dependencies
        run: dotnet restore QRCoder.Core.sln --ignore-failed-sources

      - name: ðŸ“¦ Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: ðŸ”§ Restore .NET local tools
        run: dotnet tool restore

      - name: ðŸ“Š Generate Coverage Report
        run: |
          echo "Generating coverage report"
          reportgenerator -reports:TestResults/**/coverage.cobertura.xml -targetdir:TestResults/CoverageReport -reporttypes:Html;XmlSummary;TextSummary

      - name: ðŸ“Š Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: TestResults/CoverageReport/Summary.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: ðŸ“¤ Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-coverage
          path: TestResults/
          retention-days: 7

      - name: ðŸ“¤ Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: TestResults/CoverageReport/
          retention-days: 7

      - name: ðŸ“Š Generate Coverage Summary
        run: |
          echo "## ðŸ“Š Coverage Report Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Test Coverage Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Results**: Available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **Coverage Report**: Generated and uploaded" >> $GITHUB_STEP_SUMMARY
          echo "- **Codecov**: Uploaded to Codecov platform" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts**: Available for download" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- **Codecov**: [View Coverage Report](https://codecov.io/gh/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts**: Download from Actions tab" >> $GITHUB_STEP_SUMMARY

  # Build Summary
  build-summary:
    name: ðŸ“Š Build Summary
    runs-on: ubuntu-latest
    needs:
      [build-qrcoder, build-frameworks, security, pack-nuget, coverage-reports]
    if: always()

    steps:
      - name: ðŸ“Š Generate Build Summary
        run: |
          echo "## ðŸš€ Build & Pack Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ QRCoder.Core Build | ${{ needs.build-qrcoder.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”— Framework Builds | ${{ needs.build-frameworks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Security & Quality | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ NuGet Packages | ${{ needs.pack-nuget.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Coverage Reports | ${{ needs.coverage-reports.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸŽ¯ Build Configuration**: ${{ env.BUILD_CONFIG }}" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ§ª Tests Executed**: ${{ env.RUN_TESTS }}" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“¦ Packages Created**: ${{ env.PACK_NUGET }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Target Frameworks" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… .NET Standard 2.1" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… .NET 8.0" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… .NET Framework 4.8" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Results**: Available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **Coverage Reports**: Available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **NuGet Packages**: Available in artifacts" >> $GITHUB_STEP_SUMMARY
