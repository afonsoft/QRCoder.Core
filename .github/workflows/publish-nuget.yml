name: ğŸ“¦ Publish NuGet

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (e.g., 1.0.0)"
        required: true
        default: "1.0.0"
      publish_nuget:
        description: "Publish to NuGet.org"
        required: true
        default: true
        type: boolean

env:
  DOTNET_VERSION: "10.0.x"

jobs:
  # Build and Test
  build-and-test:
    name: ğŸ”¨ Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ—„ï¸ Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ”§ Restore Dependencies
        run: dotnet restore QRCoder.Core.sln

      - name: ğŸ”¨ Build Solution
        run: dotnet build QRCoder.Core.sln --configuration Release --no-restore

      - name: ğŸ§ª Run Tests
        run: dotnet test QRCoder.Core.Tests/ --configuration Release --no-build --verbosity normal

  # Publish to NuGet
  publish:
    name: ğŸ“¦ Publish to NuGet
    runs-on: ubuntu-latest
    needs: build-and-test
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_nuget == 'true')

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ—„ï¸ Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ”§ Restore Dependencies
        run: dotnet restore QRCoder.Core.sln

      - name: ğŸ”¨ Build Solution
        run: dotnet build QRCoder.Core.sln --configuration Release --no-restore

      - name: ğŸ“¦ Pack NuGet Package
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            echo "Building version $VERSION from workflow_dispatch"
            dotnet pack QRCoder.Core/QRCoder.Core.csproj \
              --configuration Release \
              --no-build \
              --output ./nupkg \
              -p:Version=$VERSION \
              -p:PackageReleaseNotes="Release version $VERSION"
          else
            # Extract version from tag
            VERSION=$(echo ${{ github.ref_name }} | sed 's/^v//')
            echo "Building version $VERSION from tag"
            dotnet pack QRCoder.Core/QRCoder.Core.csproj \
              --configuration Release \
              --no-build \
              --output ./nupkg \
              -p:Version=$VERSION \
              -p:PackageReleaseNotes="Release version $VERSION"
          fi

      - name: ğŸ“¤ Upload Package Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          path: ./nupkg/*.nupkg
          retention-days: 30

      - name: ğŸ“¦ Publish to NuGet.org
        run: |
          echo "ğŸ“¦ Publishing to NuGet.org"
          dotnet nuget push ./nupkg/*.nupkg \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate \
            --no-symbols

      - name: ğŸ“¦ Publish to GitHub Packages
        run: |
          echo "ğŸ“¦ Publishing to GitHub Packages"
          dotnet nuget push ./nupkg/*.nupkg \
            --api-key ${{ secrets.GITHUB_TOKEN }} \
            --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json \
            --skip-duplicate \
            --no-symbols

      - name: ğŸ“Š Generate Release Summary
        run: |
          echo "## ğŸ“¦ NuGet Publishing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ Published Version" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "- **Version**: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Version**: $(echo ${{ github.ref_name }} | sed 's/^v//')" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Source**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ Package Locations" >> $GITHUB_STEP_SUMMARY
          echo "- **NuGet.org**: [QRCoder.Core](https://www.nuget.org/packages/QRCoder.Core)" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Packages**: [QRCoder.Core](https://github.com/${{ github.repository }}/pkgs/container/qrcoder-core)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **NuGet Packages**: Available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Logs**: Available in workflow run" >> $GITHUB_STEP_SUMMARY

  # Create GitHub Release
  create-release:
    name: ğŸ·ï¸ Create Release
    runs-on: ubuntu-latest
    needs: publish
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ“¥ Download Package Artifacts
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages
          path: ./nupkg

      - name: ğŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## ğŸ‰ Release ${{ github.ref_name }}

            ### ğŸ“¦ Package Information
            - **Version**: ${{ github.ref_name }}
            - **Commit**: ${{ github.sha }}
            - **Build**: [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### ğŸ“¦ Installation
            ```bash
            dotnet add package QRCoder.Core --version ${{ github.ref_name }}
            ```

            ### ğŸ“‹ Changes
            <!-- Add your release notes here -->
            - Updated CI/CD pipeline
            - Improved test coverage
            - Enhanced documentation

            ### ğŸ”— Links
            - **NuGet Package**: [QRCoder.Core on NuGet](https://www.nuget.org/packages/QRCoder.Core)
            - **GitHub Packages**: [QRCoder.Core on GitHub](https://github.com/${{ github.repository }}/pkgs/container/qrcoder-core)
            - **Documentation**: [README](https://github.com/${{ github.repository }}/blob/main/README.md)

          files: ./nupkg/*.nupkg
          draft: false
          prerelease: contains(github.ref, 'beta') || contains(github.ref, 'rc') || contains(github.ref, 'alpha')
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
