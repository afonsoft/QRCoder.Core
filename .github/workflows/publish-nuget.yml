name: ðŸ“¦ Publish NuGet

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (e.g., 1.0.5)"
        required: true
        default: "1.0.5"
      prerelease:
        description: "Is this a prerelease?"
        required: true
        default: false
        type: boolean

env:
  DOTNET_VERSION: "8.0.x"
  BUILD_CONFIG: "Release"

jobs:
  # Validate and Build
  build:
    name: ðŸ—ï¸ Build & Validate
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ðŸ—„ï¸ Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ”§ Restore Dependencies
        run: dotnet restore QRCoder.Core.sln

      - name: ðŸ—ï¸ Build Solution
        run: |
          dotnet build QRCoder.Core.sln \
            --configuration ${{ env.BUILD_CONFIG }} \
            --no-restore \
            /p:ContinuousIntegrationBuild=true

      - name: ðŸ§ª Run Tests
        run: |
          dotnet test QRCoder.Core.Tests/ \
            --configuration ${{ env.BUILD_CONFIG }} \
            --no-build \
            --logger "trx;LogFileName=test-results.trx" \
            --results-directory TestResults

      - name: ðŸ“¤ Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-publish
          path: TestResults/**/*.trx
          retention-days: 7

  # Publish to NuGet
  publish:
    name: ðŸ“¦ Publish to NuGet
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v6

      - name: ðŸ—„ï¸ Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ”§ Restore Dependencies
        run: dotnet restore QRCoder.Core.sln

      - name: ðŸ“¦ Pack NuGet Packages
        run: |
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          if [[ "$VERSION" == v* ]]; then
            VERSION="${VERSION:1}"
          fi

          PRERELEASE_FLAG=""
          if [[ "${{ github.event.inputs.prerelease }}" == "true" ]] || [[ "${{ github.event.release.prerelease }}" == "true" ]]; then
            PRERELEASE="-beta"
          fi

          dotnet pack QRCoder.Core.sln \
            --configuration ${{ env.BUILD_CONFIG }} \
            --output ./packages \
            --no-build \
            /p:ContinuousIntegrationBuild=true \
            /p:PackageVersion=${VERSION}${PRERELEASE}

      - name: ðŸ“¦ Publish to NuGet.org
        run: |
          dotnet nuget push ./packages/*.nupkg \
            --source 'https://api.nuget.org/v3/index.json' \
            --api-key ${{ secrets.NUGET_TOKEN }} \
            --skip-duplicate

      - name: ðŸ“¦ Publish to GitHub Packages
        run: |
          dotnet nuget push ./packages/*.nupkg \
            --source 'https://nuget.pkg.github.com/afonsoft/index.json' \
            --api-key ${{ secrets.GITHUB_TOKEN }} \
            --skip-duplicate

      - name: ðŸ“¤ Upload Package Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          path: ./packages/*.nupkg
          retention-days: 30

      - name: âœ… Publish Summary
        run: |
          echo "## ðŸ“¦ NuGet Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Published Packages" >> $GITHUB_STEP_SUMMARY
          echo "- **QRCoder.Core**: Published to NuGet.org" >> $GITHUB_STEP_SUMMARY
          echo "- **QRCoder.Core**: Published to GitHub Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- **NuGet.org**: [View Package](https://www.nuget.org/packages/QRCoder.Core)" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Packages**: [View Packages](https://github.com/afonsoft/QRCoder.Core/packages)" >> $GITHUB_STEP_SUMMARY
